<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Kris\LaravelFormBuilder\FormBuilderTrait;
use App\Forms\ScoreForm;

use DB;
use Session;
use App\Helpers\Part;
use App\Helpers\Auth;
use App\Helpers\Error;


class FilterController extends Controller
{
    use FormBuilderTrait;

    private $biz_part;
    private $auth;

    private function prepare()
    {
        $this->auth = new Auth;

        $records = DB::table('biz')
                        ->leftJoin('lessons', 'biz.id', '=', 'lessons.biz_id')
                        ->leftJoin('customers', 'biz.customer_id', '=', 'customers.id')
                        ->leftJoin('branches', 'biz.branch', '=', 'branches.id')
                        ->leftJoin('classes', 'biz.class_id', '=', 'class_id')
                        ->leftJoin('branches as cb', 'classes.branch', '=', 'cb.id')
                        ->leftJoin('config', 'biz.licence_type', '=', 'config.id')
                        ->where('biz.finished', false)
                        ->where(function ($query) {
                        // 分支机构限制
                        if($this->auth->branchLimit() || ($this->auth->admin() && Session::has('branch_set')  && Session::get('branch_set') != 1)) {
                                $query->Where('biz.branch', $this->auth->branchLimitId());
                            }
                        })

                        ->select(
                            'biz.id',
                            'customers.name as customer_name',
                            'customers.mobile as customer_mobile',
                            'customers.id_number as customer_id_number',
                            'branches.text as branch_text',
                            'config.text as licence_type_text',
                            'cb.text as class_branch_text',
                            'classes.class_no as class_no',
                            DB::raw('count(lessons.id) as lessons_num, max(lessons.lesson) as max_lesson')
                        );
        return $records;
    }

    // 处理器
    private function router($key)
    {
        switch ($key) {
            case 'no_class':
                $tmp = $this->prepare()
                        ->where('biz.class_id', null);
                return $tmp;
                break;

            case 'ready_for_1': 
                /**
                 * 1. 已开班
                 * 2. 没有科目成绩记录的
                 * 3. 有记录, 但只有科目1记录, 且没过的
                 */
                $fail = $this->prepare()
                            ->whereNotNull('biz.class_id')
                            ->where('lessons.lesson', 1)
                            ->where('lessons.end', false)   
                            ->where('lessons.doing', false);    
                            
                $new = $this->prepare()
                        ->whereNotNull('biz.class_id')
                        ->havingRaw('count(lessons.id) = 0')
                        ->union($fail);

                return $new;
                break;

            case 'date_for_1': 
                 /**
                 * 1. 已开班
                 * 2. 有科目1记录, 且最高为科目1
                 * 3. 准备状态 - V
                 * 4. 预约日期 - 空
                 * 5. 通过状态 - X
                 */
                $tmp = $this->prepare()
                        ->whereNotNull('biz.class_id')
                        ->where('lessons.end', false)
                        ->where('lessons.doing', true)
                        ->where('lessons.lesson', 1)
                        ->where('lessons.ready', true)
                        ->whereNull('lessons.order_date')
                        ->where('lessons.pass', false);

                return $tmp;
                break;

            case 'fail_for_1': 
                /**
                 * 1. 已开班
                 * 2. 没有科目成绩记录的
                 * 3. 有记录, 但只有科目1记录, 且没过的
                 */
                $fail = $this->prepare()
                            ->whereNotNull('biz.class_id')
                            ->where('lessons.lesson', 1)
                            ->where('lessons.end', false)   
                            ->where('lessons.doing', false);

                return $fail;
                break;

            case 'ready_for_2': 
                /**
                 * 1. 已开班
                 * 2. 科目1合格, 没报科目2,3的
                 * 3. 有科目2,但没过的
                 */
                $fail_2 = $this->prepare()
                            ->whereNotNull('biz.class_id')
                            ->where('lessons.lesson', 2)
                            ->where('lessons.end', false)   
                            ->where('lessons.doing', false);   
                            

                $pass_1 = $this->prepare()
                            ->whereNotNull('biz.class_id')
                            ->havingRaw('max(lessons.lesson) < 2')
                            ->where('lessons.lesson', 1)
                            ->where('lessons.end', true)   
                            ->where('lessons.pass', true)   
                            ->where('lessons.doing', false)
                            ->union($fail_2);

                return $pass_1;
                break;

            case 'date_for_2': 
                 /**
                 * 1. 已开班
                 * 2. 有科目1记录, 且最高为科目1
                 * 3. 准备状态 - V
                 * 4. 预约日期 - 空
                 * 5. 通过状态 - X
                 */
                $tmp = $this->prepare()
                        ->whereNotNull('biz.class_id')
                        ->where('lessons.end', false)
                        ->where('lessons.doing', true)
                        ->where('lessons.lesson', 2)
                        ->where('lessons.ready', true)
                        ->whereNull('lessons.order_date')
                        ->where('lessons.pass', false);

                return $tmp;
                break;

            case 'fail_for_2': 
                /**
                 * 1. 已开班
                 * 2. 没有科目成绩记录的
                 * 3. 有记录, 但只有科目1记录, 且没过的
                 */
                $fail = $this->prepare()
                            ->whereNotNull('biz.class_id')
                            ->where('lessons.lesson', 2)
                            ->where('lessons.end', false)   
                            ->where('lessons.doing', false);

                return $fail;
                break;

            default:
                return $this->prepare();
                break;
        }
    }
    // 默认跳转
    public function index()
    {
        return redirect('/filter/no_class');
    }

    // 过滤器
    public function filter($key)
    {
        $records = $this->router($key)
                        ->groupBy('biz.id')
                        ->get();
                        // ->toArray();

        for ($i=0; $i < count($records); $i++) { 
            if(!$records[$i]->customer_id_number) unset($records[$i]);
        }

        // 取记录集
        $this->biz_part = $records;
        // print_r($records);

        return view('filters.index')->with('records', $records);
    }


    // part
    public function ex(Request $request)
    {
        $key = $request->action;

        switch ($key) {
            case 'no_class':
                return redirect('/import/class') ;
                break;

            case 'ready_for_1': 
                $post_url = '/filter/ready/ex';
                $btn_txt = '同批提交至: 科目1预约';

                // return $this->exNote($request, $post_url, $btn_txt);
                return $this->exNote($request, $post_url, $btn_txt, $date_input=false, $lesson=1, $order_date=false);
                break;

            case 'date_for_1': 
                $post_url = '/filter/date/ex';
                $btn_txt = '批量设置科目1考试日期';

                // return $this->exNote($request, $post_url, $btn_txt, $date_input=true);
                return $this->exNote($request, $post_url, $btn_txt, $date_input=true, $lesson=1, $order_date=false);
                break;

            case 'score_ex': 
                $post_url = '/filter/score_ex/save';
                $btn_txt = '登记为通过';

                return $this->exNote($request, $post_url, $btn_txt, $date_input=false, $lesson=$request->lesson, $order_date=$request->order_date);
                break;

            case 'ready_for_2': 
                $post_url = '/filter/ready/ex';
                $btn_txt = '同批提交至: 科目2预约';

                return $this->exNote($request, $post_url, $btn_txt, $date_input=false, $lesson=2, $order_date=false);
                break;

            case 'date_for_2': 
                $post_url = '/filter/date/ex';
                $btn_txt = '批量设置科目2考试日期';

                // return $this->exNote($request, $post_url, $btn_txt, $date_input=true);
                return $this->exNote($request, $post_url, $btn_txt, $date_input=true, $lesson=2, $order_date=false);
                break;
            
            default:
                return $this->prepare();
                break;
        }
    }

    // 处理器: 准备
    public function readyEx (Request $request)
    {
        $resault = $request->type == 1 ? $request->diff_id :$request->spec_id;

        $error = new Error;
        if(!$resault) return $error->paramLost();

        $array_resault = explode(',', $resault);
        $out = [];

        foreach ($array_resault as $key) {
            $item = ['biz_id'=>$key, 'lesson'=>$request->lesson, 'doing'=>true];
            array_push($out, $item);
        }

        DB::table('lessons')
                ->whereIn('biz_id', $array_resault)
                ->where('lesson', $request->lesson)
                ->update(['doing'=>true]);

        DB::table('lessons')->insert($out);
        return view('note')->with('custom', ['color'=>'success', 'icon'=>'ok', 'content'=>'批处理已成功!']);
    }

    // 处理器: 预约日期
    public function dateEx (Request $request)
    {
        $resault = $request->type == 1 ? $request->diff_id :$request->spec_id;

        $error = new Error;
        if(!$resault) return $error->paramLost();

        $array_resault = explode(',', $resault);

        DB::table('lessons')
            // ->havingRaw('max(lesson) = 1')
            ->where('lesson', $request->lesson)
            ->whereIn('biz_id', $array_resault)
            ->where('ready', true)
            ->whereNull('order_date')
            ->where('pass', false)
            ->where('end', false)
            ->where('doing', true)
            ->update(['order_date'=> strtotime($request->date)]);

            // print_r($request->all());

        return view('note')->with('custom', ['color'=>'success', 'icon'=>'ok', 'content'=>'批处理已成功!']);
    }

    // 科目1准备好预约
    private function exNote($request, $post_url, $btn_txt, $date_input=false, $lesson=false, $order_date=false)
    {
        $all_id = $request->all_id;
        $post_data = $request->post_data;

        $error = new Error;
        if(!$all_id) return $error->paramLost();

        $all_id = substr($all_id,0,strlen($all_id)-1); 
        $all = explode(',', $all_id);
        $all_num = count($all);
        $special_num = 0;

        if($post_data) {
            $arr  = explode(',', $post_data);
            $special_num = count($arr);
            $all = array_diff($all, $arr);
        }

        $real_num = count($all);
        $diff_id = implode(',', $all);

        $txt = "<h3>多条数据将同时处理!</h3>符合条件的记录共有".$all_num."条, 其中标记".$special_num."条";

        return view('part')
                        ->with('lesson', $lesson)
                        ->with('order_date', $order_date)
                        ->with('txt', $txt)
                        ->with('date_input', $date_input)
                        ->with('post_url', $post_url)
                        ->with('btn_txt', $btn_txt)
                        ->with('all_id', $all_id)
                        ->with('spec_id', $post_data)
                        ->with('diff_id', $diff_id);

    }

    // // 科目1预约名单
    // public function ready_for_1_ex (Request $request)
    // {
    //     $resault = $request->type == 1 ? $request->diff_id :$request->spec_id;

    //     $error = new Error;
    //     if(!$resault) return $error->paramLost();

    //     $array_resault = explode(',', $resault);
    //     $out = [];

    //     foreach ($array_resault as $key) {
    //         $item = ['biz_id'=>$key, 'lesson'=>1, 'doing'=>true];
    //         array_push($out, $item);
    //     }

    //     DB::table('lessons')
    //             ->whereIn('biz_id', $array_resault)
    //             ->where('lesson', 1)
    //             ->update(['doing'=>true]);

    //     DB::table('lessons')->insert($out);
    //     return view('note')->with('custom', ['color'=>'success', 'icon'=>'ok', 'content'=>'批处理已成功!']);
    // }

    // // 科目1预约成功日期 
    // public function date_for_1_ex (Request $request)
    // {
    //     $resault = $request->type == 1 ? $request->diff_id :$request->spec_id;

    //     $error = new Error;
    //     if(!$resault) return $error->paramLost();

    //     $array_resault = explode(',', $resault);

    //     DB::table('lessons')
    //         ->havingRaw('max(lesson) = 1')
    //         ->where('lesson', 1)
    //         ->whereIn('biz_id', $array_resault)
    //         ->where('ready', true)
    //         ->where('order_date', null)
    //         ->where('pass', false)
    //         ->update(['order_date'=> strtotime($request->date)]);

    //     return view('note')->with('custom', ['color'=>'success', 'icon'=>'ok', 'content'=>'批处理已成功!']);
    // }

    // 成绩导入
    public function score ()
    {
        $form = $this->form(ScoreForm::class, [
            'method' => 'POST',
            'url' => route('score.ex')
        ]);

        $title = '成绩处理';
        $icon = 'check';

        return view('form', compact('form'))->with('custom',['title'=>$title, 'icon'=>$icon]);
    }

    // 学员列表
    public function score_ex (Request $request)
    {
        $order_date = strtotime($request->order_date);

        $records = $this->prepare()
                        ->whereNotNull('biz.class_id')
                        // ->havingRaw('max(lessons.lesson) = '.$request->lesson)
                        ->where('lessons.lesson', $request->lesson)
                        ->where('lessons.ready', true)
                        ->where('lessons.order_date', $order_date)
                        ->where('lessons.pass', false)
                        ->groupBy('biz.id')
                        ->get();

        return view('filters.index')
                    ->with('order_date', $order_date)
                    ->with('lesson', $request->lesson)
                    ->with('records', $records);
    }

    // 保存成绩
    public function score_save(Request $request)
    {
       $resault = $request->type == 1 ? $request->diff_id :$request->spec_id;
       $others = $request->type == 2 ? $request->diff_id :$request->spec_id;

        $error = new Error;
        if(!$resault) return $error->paramLost();

        // 失败者
        if($others) {
            $others_array = explode(',', $others);

            DB::table('lessons')
                ->where('lesson', $request->lesson)
                ->whereIn('biz_id', $others_array)
                ->where('ready', true)
                ->where('order_date', $request->order_date)
                ->where('pass', false)
                ->update(['doing'=>false]);

        } 

        $array_resault = explode(',', $resault);
        // print_r($request->all());
        // 成功者
        DB::table('lessons')
            // ->havingRaw('max(lesson) = '.$request->lesson)
            ->where('lesson', $request->lesson)
            ->whereIn('biz_id', $array_resault)
            ->where('ready', true)
            ->where('order_date', $request->order_date)
            ->where('pass', false)
            ->update(['pass'=> true, 'doing'=>false]);

        DB::table('lessons')
            ->where('lesson', $request->lesson)
            ->whereIn('biz_id', $array_resault)
            ->update(['end'=>true]);

        return view('note')->with('custom', ['color'=>'success', 'icon'=>'ok', 'content'=>'批处理已成功!']);
    }




    // public function checking(Request $request)
    // {
    //     $ticket_no = $request->input('no');
    //     $id = $request->input('id');
    //     // 授权
    //     $auth = new Auth;
    //     if(!$auth->finance())  return "无权操作";

    //     $target = Finance::find($id)->update(['checked' => true, 'checked_by'=>Session::get('id'), 'checked_by_time'=>time(), 'ticket_no'=>$ticket_no]);
    //     // return redirect('/finance');
    //     // echo 'fuck';
    //     return '票号:'.$ticket_no.'已成功审核!';
    // }

    // end
}









